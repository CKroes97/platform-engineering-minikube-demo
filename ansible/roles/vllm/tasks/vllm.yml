---
- name: Ensure vllm service user exists
  ansible.builtin.user:
    name: "{{ service_user }}"
    shell: /sbin/nologin
    system: true
    create_home: true

- name: Create systemd service for vllm-server
  ansible.builtin.copy:
    dest: /etc/systemd/system/{{ service_name }}.service
    mode: '0644'
    content: |
      [Unit]
      Description=vllm server serving GPT-OSS-20B
      After=network.target

      [Service]
      Type=simple
      User={{ service_user }}
      WorkingDirectory={{ vllm_venv_path }}
      ExecStart=vllm serve openai/gpt-oss-20b \
        --host 0.0.0.0 \
        --port 39443 \
        --enable-tool-calling \
        --tool-choice-mode auto \
        --tensor-parallel-size 1 \
        --gpu-memory-utilization 0.9 \
        --max-model-len 8192 \
        --max-num-batched-tokens 2048
      Restart=on-failure
      RestartSec=5
      Environment=vllm_LOG_LEVEL=info

      [Install]
      WantedBy=multi-user.target

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true

- name: Enable and start vllm-server
  ansible.builtin.systemd:
    name: "{{ service_name }}"
    state: started
    enabled: true
